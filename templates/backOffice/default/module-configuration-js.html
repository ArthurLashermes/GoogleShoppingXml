{default_translation_domain domain='googleshopping.ai'}

<script>

    $(document).ready(function(){
        $('[data-toggle="tooltip"]').tooltip();
    });

    $(function () {


        // ***********************************************
        //            FEED MANAGEMENT TAB
        // ***********************************************

        // Copy link to clipboard

        $('.js_btn_clipboard').on('click', function(e){
            e.preventDefault();
            if(setClipboardText(this.dataset.clipboardtext)){
                var btn = this;
                setTimeout(function(){
                    btn.dataset.originalTitle = "{intl l='Copied!'}";
                    $(btn).tooltip('show');
                }, 100)
            }
        });

        function setClipboardText(text){
            var id = "mycustom-clipboard-textarea-hidden-id";
            var existsTextarea = document.getElementById(id);

            if(!existsTextarea){
                var textarea = document.createElement("textarea");
                textarea.id = id;
                textarea.style.position = 'fixed';
                textarea.style.top = 0;
                textarea.style.left = 0;
                textarea.style.width = '1px';
                textarea.style.height = '1px';
                textarea.style.padding = 0;
                textarea.style.border = 'none';
                textarea.style.outline = 'none';
                textarea.style.boxShadow = 'none';
                textarea.style.background = 'transparent';
                document.querySelector("body").appendChild(textarea);
                existsTextarea = document.getElementById(id);
            }

            existsTextarea.value = text;
            existsTextarea.select();

            try {
                var status = document.execCommand('copy');
                if(status){
                    return true;
                }
            } catch (err) { }

            return false;
        }



        // Delete feed - Confirm dialog

        $('#js_btn_modal_confirm_delete_confirm').on('click',function(e){
            e.preventDefault();
            var formid = this.dataset.formid;
            this.dataset.formid = '';
            if (formid != "" && formid != null) {
                $('#'+formid).submit();
            }
            $('#js_modal_confirm_delete').modal("hide");
        });

        $('.js_btn_delete_with_warning').on('click', function(e) {
            e.preventDefault();
            var $warningLine1 = "{intl l='Do you really want to delete this feed ?'}";
            var $warningLine2 = "{intl l='Please note that it won\'t delete the feed in your Google Merchant account. You will have to do it manually in the Google Merchant Center page.'}";
            document.getElementById('js_btn_modal_confirm_delete_confirm').dataset.formid = this.dataset.formid;
            $('#js_body_modal_confirm_delete').html('<strong>' + $warningLine1 + '</strong><p>' + $warningLine2 + '</p>');
            $('#js_modal_confirm_delete').modal("show");
        });



        // Configure custom XML modal

        $('.js_btn_configure_custom_xml').on('click',function(e){
            e.preventDefault();
            var $modalCustomXml = $('#js_modal_custom_xml');
            $modalCustomXml.modal();
            document.getElementById('js_btn_generate_custom_xml').dataset.feedid = this.dataset.feedid;
        });


        $('#js_btn_generate_custom_xml').on('click',function(e){
            e.preventDefault();
            var feedid = this.dataset.feedid;
            var numberOfDivisions = $('#js_input_xml_divide_time').val();
            var nb_pse = {$pse_count};
            var base_url = $('.js_download_xml_feed[data-feedid='+feedid+']').attr('href');
            console.log(base_url);

            var limit = Math.ceil(nb_pse / numberOfDivisions);

            var html = '<ul>';
            for (var i=0; i < numberOfDivisions; i++){
                var offset = i * limit;
                if (offset+1 > nb_pse){
                    break;
                }
                var url = base_url+'?offset='+offset+'&limit='+limit;

                var end = offset+limit;
                if (end > nb_pse){
                    end = nb_pse;
                }
                html += '<li><a href="'+url+'" download>Xml file part '+(i+1)+' : items '+(offset+1)+' to ' + end +'</a></li>';
            }
            html += '</ul>';
            document.getElementById('js_xml_divided_link_container').innerHTML = html;

            console.log(nb_pse);
            console.log(limit);
        });



        // ***********************************************
        //            GOOGLE TAXONOMY TAB
        // ***********************************************


        var searchTimer = null;
        $("#search-taxonomy").keyup(function () {
            search = $(this).val();

            if (searchTimer !== null) {
                clearTimeout(searchTimer);
            }

            if (search.length > 2) {
                searchTimer = setTimeout(function() {
                    $.get('{url path="/admin/module/googleshoppingxml/taxonomy/{lang attr="id"}"}', function (data) {
                        var res = "";
                        console.log("Cats received.");
                        $.each(data.cats, function (k, v) {
                            var searchUp = search.toUpperCase();
                            var googleCategoryName = v.split(' &gt; ').pop();
                            var googleCategoryNameUp = googleCategoryName.toUpperCase();
                            if (-1 !== googleCategoryNameUp.search(searchUp)) {
                                res += '<option value="' + k + '">' + googleCategoryName + '</option>';
                            }
                        });
                        $("#google-taxonomy").html(res);
                    })
                }, 350, this);
            }
        });



        // ***********************************************
        //         ADVANCED CONFIGURATION TAB
        // ***********************************************


        $('.js_field_related_to_association_type').hide();

        var $advanced_select_association_type = $('.js_advanced_select_association_type');

        $advanced_select_association_type.change(function(e){
            var associationType = $(this).val();
            var googleFieldId = this.dataset.googlefieldid;
            $('.js_field_related_to_association_type[data-googlefieldid="'+googleFieldId+'"]').hide();
            $('.js_field_related_to_association_type[data-googlefieldid="'+googleFieldId+'"][data-associationtype="'+associationType+'"]').show();
        });

        $advanced_select_association_type.trigger( "change" );

    });
</script>