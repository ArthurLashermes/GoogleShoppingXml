<?xml version="1.0"?>
<rss xmlns:g="http://base.google.com/ns/1.0" version="2.0">
    <channel>
        <title>{config key="store_name"}</title>
        <link>{navigate to="index"}</link>
        <description>{config key="store_description"}</description>

        {loop type="currency" name="feed_currency" id={$feed_currency_id}}
        {$feed_currency_code = $ISOCODE}
        {/loop}

        {loop type="product" name="product-loop" lang={$feed_lang_id} currency={$feed_currency_id}}
        {$ID_PRODUCT = $ID}
        {$REF_PRODUCT = $REF}

        {loop type="product_sale_elements" name="pse-loop" product={$ID_PRODUCT}}
        {$ID_PSE = $ID}
        <item>
            <g:id>{$REF}</g:id>
            <g:title>{$TITLE}{loop type="attribute_combination" name="loop_attribute_combination_title" product_sale_elements={$ID_PSE} lang={$feed_lang_id}} - {$ATTRIBUTE_AVAILABILITY_TITLE}{/loop}</g:title>
            <g:description>{$DESCRIPTION}</g:description>
            <g:link>{$URL}</g:link>

            {loop type="image" name="image.main" product={$ID_PRODUCT} limit="1"}
            <g:image_link>{$IMAGE_URL}</g:image_link>
            {/loop}

            {$check_availability={config key="check-available-stock" default="1"}}
            {if $check_availability == 1 && $QUANTITY <= 0}
            <g:availability>out of stock</g:availability>
            {else}
            <g:availability>in stock</g:availability>
            {/if}

            <g:price>{format_money number=$TAXED_PRICE symbol={$feed_currency_code}}</g:price>

            {if $TAXED_PROMO_PRICE < $TAXED_PRICE && $TAXED_PROMO_PRICE != 0}
            <g:sale_price>{format_money number=$TAXED_PROMO_PRICE symbol={$feed_currency_code}}</g:sale_price>
            {/if}

            {loop type="brand" name="brand-product-loop" id={$BRAND_ID}}
            <g:brand>{$TITLE}</g:brand>
            {/loop}

            {if $EAN_CODE}
            <g:gtin>{$EAN_CODE}</g:gtin>
            <g:identifier_exists>yes</g:identifier_exists>
            {else}
            <g:identifier_exists>no</g:identifier_exists>
            {/if}


            <g:item_group_id>{$REF_PRODUCT}</g:item_group_id>

            {loop type="googleshoppingxml.xml.shipping" feed_id={$feed_id} name="googleshoppingxml_shipping"}
            <g:shipping>
                <g:country>{$COUNTRY_CODE}</g:country>
                <g:service>{$SERVICE}</g:service>
                <g:price>{format_money number=$PRICE symbol={$CURRENCY_CODE}}</g:price>
            </g:shipping>
            {/loop}

            {loop type="googleshoppingxml.category.or.parent" lang_id={$feed_lang_id} category_id={$DEFAULT_CATEGORY} name="googleshoppingxml_category_associated"}
            <g:google_product_category>{$GOOGLE_CATEGORY}</g:google_product_category>
            {/loop}

            <g:product_type>{loop name="category-path-product-type" type="category-path" category={$DEFAULT_CATEGORY}}{loop type="category" name="category-lang-product-type" lang={$feed_lang_id} id={$ID}}{$TITLE}{/loop}{if $LOOP_COUNT < $LOOP_TOTAL} &gt; {/if}{/loop}</g:product_type>


            {foreach from=$field_association_array item=field_association}

            {$GOOGLE_FIELD = $field_association.GoogleField}
            {$ASSOCIATION_TYPE = $field_association.AssociationType}

            {if $GOOGLE_FIELD == 'condition'}
            {$isConditionDefined = 'yes'}
            {/if}

            {if $ASSOCIATION_TYPE == 1}
            <g:{$GOOGLE_FIELD}>{$field_association.FixedValue}</g:{$GOOGLE_FIELD}>
            {/if}

            {if $ASSOCIATION_TYPE == 2}
            {ifloop rel="loop_attribute_combination_advanced_field"}
            <g:{$GOOGLE_FIELD}>{loop type="attribute_combination" name="loop_attribute_combination_advanced_field" product_sale_elements={$ID_PSE} lang={$feed_lang_id}}{if $ATTRIBUTE_ID == $field_association.IdRelatedAttribute}{$ATTRIBUTE_AVAILABILITY_TITLE}{/if}{/loop}</g:{$GOOGLE_FIELD}>
            {/ifloop}
            {/if}

            {if $ASSOCIATION_TYPE == 3}
            {ifloop rel="loop_feature_value"}
            <g:{$GOOGLE_FIELD}>{loop type="feature_value" name="loop_feature_value" feature={$field_association.IdRelatedFeature} product={$ID_PRODUCT} lang={$feed_lang_id}}{if $LOOP_COUNT > 1}/{/if}{$TITLE}{/loop}</g:{$GOOGLE_FIELD}>
            {/ifloop}
            {/if}

            {/foreach}

            {if !$isConditionDefined}
            <g:condition>new</g:condition>
            {/if}

        </item>

        {/loop}
        {/loop}

    </channel>
</rss>